/*
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë                 Projeto: SafeGuard e 7life                 ‚ïë
  ‚ïë                  Plataforma: ESP32 + MQTT                  ‚ïë
  ‚ïë------------------------------------------------------------‚ïë
  ‚ïë  Descri√ß√£o:                                                ‚ïë
  ‚ïë  C√≥digo desenvolvido para ler sensores de batimentos,      ‚ïë
  ‚ïë  oxigena√ß√£o (SpO2) e temperatura corporal. Os dados s√£o    ‚ïë
  ‚ïë  exibidos em um display OLED e enviados via MQTT para um   ‚ïë
  ‚ïë  servidor central para monitoramento remoto.               ‚ïë
  ‚ïë                                                            ‚ïë
  ‚ïë  Funcionalidades:                                          ‚ïë
  ‚ïë   - Leitura dos sensores MAX30102 e MLX90614 via I2C       ‚ïë
  ‚ïë   - Exibi√ß√£o dos dados em display SSD1306                  ‚ïë
  ‚ïë   - Comunica√ß√£o via Wi-Fi + MQTT (PubSubClient)            ‚ïë
  ‚ïë   - Sincroniza√ß√£o com hor√°rio NTP                          ‚ïë
  ‚ïë                                                            ‚ïë
  ‚ïë  Autor: grupo7zipado                                       ‚ïë
  ‚ïë  Curso: T√©cnico em Redes de Computadores                   ‚ïë
  ‚ïë  Institui√ß√£o: ETEC Tup√£ Prof. Massuyuki Kawano             ‚ïë
  ‚ïë  Github: github.com/grupo7zipado                           ‚ïë
  ‚ïë                                                            ‚ïë
  ‚ïë  Data de cria√ß√£o: 31/05/2025                               ‚ïë
  ‚ïë  Vers√£o: 1.1.3                                             ‚ïë
  ‚ïë  Licen√ßa: MIT                                              ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
*/

/*
  RECADOS

  ‚öôÔ∏è CONFIGURA√á√ïES DE REDE

  Altere as vari√°veis abaixo conforme sua rede:
  - BROKER_IP     ‚Üí IP do broker MQTT
  - BROKER_PORT   ‚Üí Porta do broker
  - SSID          ‚Üí Nome da rede Wi-Fi
  - PASSWORD      ‚Üí Senha do Wi-Fi
*/

/*
  BIBLIOTECAS
*/


/*
  Configura√ß√£o de I2C (Inter-Integrated Circuit)
*/
#include <Wire.h> 

/*
  Conex√£o Wireless WiFi
*/
#include <WiFi.h> 

/*
  Manipula√ß√£o de Mem√≥ria Permanente
*/
#include <Preferences.h> 

/*
  Conex√£o NTP (Network Time Protocol)
*/
#include <time.h>

/*
  Biblioteca do Sensor Ox√≠metro
*/
#include "MAX30105.h" 

/*
  Biblioteca de C√°lculo BPM e Oxigena√ß√£o
*/
#include "heartRate.h" 

/*
  Biblioteca do Sensor de Temperatura
*/
#include <Adafruit_MLX90614.h>

/*
  Biblioteca de Controle do Display
*/
#include <Adafruit_SSD1306.h>

/*
  Biblioteca do MQTT (Message Queuing Telemetry Transport)
*/
#include <PubSubClient.h>

/*
  Biblioteca de Formato JSON para IoT
  JSON (JavaScript Object Notation)
  IoT (Internet of Things)
*/
#include <ArduinoJson.h>


/*
  INST√ÇNCIAS DE OBJETOS
*/

/*
  // -----[Preferences]----- //
  Ger√™ncia o Armazenamento Dados de Forma Persistente na Mem√≥ria Flash (NVS - Non-Volatile Storage)
*/
Preferences prefs;

/*
  // -----[WiFi]----- //
  Permite Conex√µes Wireless Possibilitando comunicar-se pela internet ou rede local
*/
WiFiClient espClient;

/*
  // -----[PubSubClient]----- //
  Comunica√ß√£o Via Protocolo MQTT, Permitindo que o Microcontrlador 
  Publique Dados (Como Sensores) e Receba Comandos de um Broker MQTT
*/
PubSubClient mqttClient(espClient);

/*
  // -----[I2C]----- //
  Permite a Cria√ß√£o de Mais de um Barramento I2C Funcionando ao Mesmo Tempo
*/ 
TwoWire I2C_0 = TwoWire(0);

/*
  // -----[MAX30105-Ox√≠metro]----- //
  Objeto do Sensor MAX30105 para Leitura de SpO2 e BPM
*/
MAX30105 particleSensor;

/*
  // -----[MLX90614-Temperatura]----- //
  Objeto do Sensor MLX90614 para Leitura da Temperatura
*/
Adafruit_MLX90614 mlx = Adafruit_MLX90614();

/*
  // -----[Display-OLED]----- //
  Objeto do Display OLED para Exibir os Dados no Display
*/
Adafruit_SSD1306 display(128, 64, &I2C_0, -1);


/*
  VARI√ÅVEIS DE GLOBAIS
*/

/*
  // -----[Wifi]----- //
  SSID - da Rede Wifi
  PASSWORD - Senha da Rede Wifi
*/
const char* ssid = "777zip";
const char* password = "R125redes";

// const char* ssid = "TP-Link_0486";
// const char* password = "46179951";



/*
  // -----[Broker]----- //
  IP_BROKER - Ip do Servi√ßo do Broker
  BROKER_PORT - Porta do Servi√ßo do Broker
  CLIENT_ID - Indentificador √önico de Conex√£o com Broker
*/
const char* ip_broker = "7life.kinghost.net";  // Ou IP do seu broker local
const int broker_port = 21000;
String client_id;

/*
  // -----[T√≥picos]----- //
  PUB - T√≥picos de Publica√ß√£o
  SUB - T√≥picos de Subscri√ß√£o
  REQUEST_USER - Requisi√ß√£o de Usu√°rio
  RESPONSE_USER - Recebe Novo Usu√°rio
  MSG - Recebe Mensagens
*/
String topic_pub_request_user;
String topic_sub_response_user;
String topic_sub_msg;

/*
  // -----[MAC]----- //
  Declara a Vari√°vel que Recebera o Endere√ßo MAC do Dispositivo
*/
String mac_address;


// -----[piezo]----- //
const int buzzerPin = 10;  

int melody[] = { 800, 0, 1000, 0, 1500 };
int durations[] = { 150, 100, 150, 100, 300 };

/*
  // -----[Usu√°rio]----- //
  Declara a Vari√°vel que Recebera o Id do Relacionamento do Esp com o Usu√°rio
*/
String user;

/*
  // -----[Dados]----- //
*/
const char* tipos[] = { "temperatura", "oxigenacao", "bpm" };

unsigned long tempoAnterior = 0;
const unsigned long intervalo = 5000; // 5 segundos


/*
  // -----[Ox√≠metro]----- //
  Vari√°veis para C√°lculos spO2 e BPM
  Vari√°veis de Setup
*/
double avered = 0;
double aveir = 0;
double sumirrms = 0;
double sumredrms = 0;
int i = 0;
int Num = 200; //intervalo de amostragem para o c√°lculo de SpO2
double ESpO2 = 95.0; // valor inicial de SpO2 estimado
double FSpO2 = 0.7;  // fator de filtro para SpO2 estimado
double frate = 0.95; // filtro passa-baixo para o valor do LED IR/vermelho

#define TIMETOBOOT 3000 // tempo de espera (ms) para a sa√≠da do SpO2
#define SCALE 88.0 // ajuste para exibir batimento card√≠aco e SpO2 na mesma escala
#define SAMPLING 5 // mais preciso se definido como 1
#define FINGER_ON 30000 // se o sinal vermelho for menor que isso, indica que o dedo n√£o est√° no sensor
#define MINIMUM_SPO2 80.0

const byte RATE_SIZE = 4; // Aumente isso para mais m√©dia. 4 √© bom.
byte rates[RATE_SIZE]; // Array de batimentos card√≠acos
byte rateSpot = 0;
long lastBeat = 0; // Hora em que ocorreu o √∫ltimo batimento
float beatsPerMinute;
int beatAvg;
double spo2 = 0.0;
double temp = 0.0;
double abpm = 0.0;
#define USEFIFO


/*
  // -----[Display]----- //
  Estados do Display
  Bitmaps
*/

// --- Estados --- //
unsigned long tempoMensagem = 0;
bool mostrandoMensagem = false;
unsigned long ultimoBatimento = 0;
bool batendo = false;

// '7zipLogo (6)', 128x64px
const unsigned char epd_bitmap_7zipLogo__6_ [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0xf8, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x0e, 0x18, 0xf0, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x03, 0xf8, 0x3e, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x01, 0xf8, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0x01, 0xc0, 0xf8, 0x03, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0x03, 0xe0, 0x78, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x0f, 0xc0, 0x78, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x0f, 0x80, 0x38, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x1f, 0x00, 0x38, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x0f, 0x00, 0x18, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x0e, 0x00, 0x18, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0x86, 0x00, 0x18, 0x00, 0x0c, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0xc2, 0x00, 0x18, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x18, 0x00, 0x04, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x00, 0x08, 0x00, 0x04, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x0f, 0xff, 0x80, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0xff, 0xc0, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x81, 0xff, 0xe0, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0xff, 0xf0, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x83, 0xf0, 0x3f, 0xf8, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc3, 0xfc, 0x1f, 0xf8, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc3, 0xfc, 0x0f, 0xfc, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc3, 0xfe, 0x07, 0xfc, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc1, 0xfe, 0x03, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc1, 0xff, 0x01, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc1, 0xff, 0x01, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x00, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x80, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0x7f, 0xc0, 0xfe, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf0, 0x7f, 0xc0, 0x7e, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf0, 0x3f, 0xe0, 0xfe, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf8, 0x1f, 0xf0, 0xfc, 0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf8, 0x1f, 0xf0, 0xfc, 0x03, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xfc, 0x07, 0xc0, 0xf8, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x01, 0xf8, 0x0e, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0x80, 0x03, 0xf0, 0x38, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc1, 0xf0, 0x0f, 0xc1, 0xf0, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x80, 0x3f, 0xff, 0x03, 0xc0, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1040)
//const int epd_bitmap_allArray_LEN = 1;
//const unsigned char* epd_bitmap_allArray[1] = {
//	epd_bitmap_7zipLogo__6_
//};


// === BITMAP DE INICIALIZA√á√ÉO ===
// '7zipLogo (5)', 128x64px
const unsigned char epd_bitmap_7zipLogo__5_ [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x0f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x3f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7f, 0xff, 0xfe, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x7f, 0xff, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0xfc, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0xf8, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xf9, 0xf8, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xf8, 0x7c, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xfc, 0x1c, 0x3f, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xfe, 0x0c, 0x1e, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0x02, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0xe0, 0x03, 0xf8, 0x03, 0xfe, 0x0e, 0x00, 0x38, 0x0f, 0xe0, 0x7f, 0x80, 
	0x00, 0x00, 0xff, 0xff, 0xf0, 0x1f, 0xf0, 0x03, 0xfe, 0x0e, 0x00, 0x38, 0x0f, 0xe0, 0x7f, 0x80, 
	0x00, 0x00, 0xff, 0xff, 0xf8, 0x3f, 0xf0, 0x00, 0x1c, 0x0e, 0x00, 0x38, 0x0f, 0xe0, 0x7f, 0x00, 
	0x00, 0x00, 0x7f, 0xff, 0xf8, 0x3f, 0xe0, 0x80, 0x1c, 0x0e, 0x00, 0x38, 0x0e, 0x00, 0x70, 0x00, 
	0x00, 0x00, 0x7f, 0xff, 0xfc, 0x7f, 0xc1, 0x80, 0x3c, 0x0e, 0x00, 0x38, 0x0e, 0x00, 0x70, 0x00, 
	0x00, 0x00, 0x3f, 0xff, 0xfc, 0x7f, 0x81, 0xc0, 0x38, 0x0e, 0x00, 0x38, 0x0f, 0xc0, 0x7f, 0x00, 
	0x00, 0x00, 0x3f, 0xff, 0xfc, 0x7f, 0x81, 0xc0, 0x38, 0x0e, 0x00, 0x38, 0x0f, 0xc0, 0x7f, 0x00, 
	0x00, 0x00, 0x1f, 0xff, 0xfc, 0x7f, 0x01, 0xc0, 0x70, 0x0e, 0x00, 0x38, 0x0f, 0xc0, 0x7f, 0x00, 
	0x00, 0x00, 0x0f, 0xff, 0xfc, 0x7e, 0x03, 0x40, 0x70, 0x0e, 0x00, 0x38, 0x0e, 0x00, 0x70, 0x00, 
	0x00, 0x00, 0x0f, 0xff, 0xf8, 0xfc, 0x03, 0x40, 0xe0, 0x0e, 0x00, 0x38, 0x0e, 0x00, 0x70, 0x00, 
	0x00, 0x00, 0x07, 0xff, 0xf8, 0xf8, 0x03, 0x60, 0xe0, 0x0e, 0x00, 0x38, 0x0e, 0x00, 0x70, 0x00, 
	0x00, 0x00, 0x03, 0xff, 0xf1, 0xe0, 0x06, 0x61, 0xe0, 0x0f, 0xf0, 0x38, 0x0e, 0x00, 0x7f, 0x80, 
	0x00, 0x00, 0x01, 0xff, 0xe3, 0xc1, 0x86, 0x61, 0xc0, 0x0f, 0xf0, 0x38, 0x0e, 0x00, 0x7f, 0x80, 
	0x00, 0x00, 0x00, 0xff, 0xc3, 0x81, 0x86, 0x21, 0xc0, 0x0f, 0xf0, 0x38, 0x0e, 0x00, 0x7f, 0x80, 
	0x00, 0x00, 0x00, 0x7f, 0xc7, 0x03, 0x84, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x3f, 0x8f, 0x03, 0xc4, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x1f, 0x8e, 0x06, 0xcc, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
	0x00, 0x00, 0x00, 0x0f, 0x1c, 0x7e, 0xcc, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
	0x00, 0x00, 0x00, 0x07, 0x1c, 0x60, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0x38, 0x00, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1040)
const int epd_bitmap_allArray_LEN = 2;
const unsigned char* epd_bitmap_allArray[2] = {
  epd_bitmap_7zipLogo__5_,
  epd_bitmap_7zipLogo__6_
};


// --- Gota de Sangue (SpO2) --- //
const unsigned char epd_bitmap_gota_de_sangue [] PROGMEM = {
  0xff, 0xff, 0xfe, 0x7f, 0xfe, 0x7f, 0xfc, 0x3f,
  0xf8, 0x1f, 0xf0, 0x1f, 0xf0, 0x0f, 0xf0, 0x0f,
  0xe0, 0x07, 0xe0, 0x07, 0xe0, 0x07, 0xe0, 0x07,
  0xf0, 0x0f, 0xf0, 0x0f, 0xfc, 0x3f, 0xff, 0xff
};
// --- Cora√ß√£o (BPM) --- //
const unsigned char epd_bitmap_coracao [] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xc3, 0xc3, 0x80, 0x01,
  0x80, 0x01, 0x00, 0x00, 0x80, 0x01, 0x80, 0x01,
  0x80, 0x01, 0xc0, 0x03, 0xe0, 0x07, 0xf0, 0x0f,
  0xfc, 0x3f, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff
};
// --- Term√¥metro (Temperatura) --- //
const unsigned char epd_bitmap_termometro [] PROGMEM = {
  0xfe, 0x7f, 0xfc, 0x3f, 0xf9, 0x9f, 0xf9, 0x9f,
  0xf9, 0x9f, 0xf9, 0x9f, 0xf8, 0x1f, 0xf8, 0x1f,
  0xf8, 0x1f, 0xf8, 0x1f, 0xf2, 0x4f, 0xf0, 0x0f,
  0xf0, 0x0f, 0xf2, 0x4f, 0xf8, 0x1f, 0xfc, 0x3f
};

/*
    FUN√á√ïES DE SETUP
*/
/*
  // -----[setup_wifi]----- //
  Fun√ß√£o para conectar ao Wi-Fi
*/ 
void setup_wifi() {
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(1000);
    }
}

/*
  // -----[mqttCallback]----- //
  Trata Mensagens Recebidas Via MQTT
  TOPIC - T√≥pico em que a Mensagem foi Recebida
  PAYLOAD - Conteudo da Mensagem
  LENGTH - Tamanho da Mensagem em Bytes
*/

void mqttCallback(char* topic, byte* payload, unsigned int length) {

  //verifica se o topico e o correto
    if(strcmp(topic, topic_sub_response_user.c_str()) == 0){
        //joga o payload(usuario) dentro de uma variavel
        String novoUser;
        for (int i = 0; i < length; i++) {
            novoUser += (char)payload[i];
        }
        // Salvar novo valor do usuario permanentemente
        prefs.begin("config", false);
        prefs.putString("user", novoUser);
        prefs.end();
        // Atualiza o valor do usu√°rio no codigo
        user = novoUser;
    }
  String msg = "";

  if (strcmp(topic, topic_sub_msg.c_str()) == 0) {
    for (int i = 0; i < length; i++) {
      msg += (char)payload[i];
    }
    tempoMensagem = millis();
    mostrandoMensagem = true;
    // LIGA O BUZER 
    playWhatsAppSound();
    displayMensagem(msg);  // ou o que voc√™ quiser fazer com a mensagem
  }

    
}


/*
  // -----[reconnect_mqtt]----- //
  Verifica se a Conex√£o Esta Ativa
  Conecta ao BrokerMQTT 
  Subscreve nos T√≥picos response_user e msg
*/
void reconnect_mqtt() {
    while (!mqttClient.connected()) {
        if (mqttClient.connect(client_id.c_str())) {
            mqttClient.subscribe(topic_sub_response_user.c_str()); 
            mqttClient.subscribe(topic_sub_msg.c_str());
        } else {
          delay(5000);
        }
    }
}


/*
  // -----[enviarPrimeiraMensagem]----- //
  Envia o Pedido do Primeiro Usu√°rio
*/
void enviarPrimeiraMensagem() {
    while (!mqttClient.publish(topic_pub_request_user.c_str(), mac_address.c_str())) {
        delay(3000);
    }

}

/*
  // -----[initI2C]----- //
  Define as Pinos SDA e SCL
  Inicia o Barramento I2C 
*/
void initI2C() {
  I2C_0.begin(8, 9); //I2C 0 para o MAX30102 e Display Oled //TEMPERATURA
}


/*
  // -----[initDisplay]----- //
  Inicia o Display
  Limpa o Display
  Atualiza o Display
*/
void initDisplay() {
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.clearDisplay();
  display.display();
}


/*
  // -----[confMAX30102]----- //
  Configura o Sensor MAX30102/30105
*/
void confMAX30102() {

  byte ledBrightness = 0x7F; //intensidade do led
  byte sampleAverage = 4; //amostras para m√©dia 
  byte ledMode = 3; //modo do led
  int sampleRate = 200; //frequ√™ncia de amostragem (Hz)
  int pulseWidth = 411; //dura√ß√£o de pulso do led
  int adcRange = 16384; // faixa de leitura adc
  
  particleSensor.setup(ledBrightness, sampleAverage, ledMode, sampleRate, pulseWidth, adcRange);
}


/*
  // -----[initSensors]----- //
  Inicia o Sensor de Ox√≠metro no Barramento I2C_0
  Inicia o Sensor de Temperatura no Barramento I2C_0
  Envia as Configura√ß√µes do Ox√≠metro
  Define a Frequ√™ncia de Comunica√ß√£o do Barramento I2C
*/
void initSensors() {
  particleSensor.begin(I2C_0); //inicia sensor MAX30102 (velocidade padr√£o 100khz) 
  I2C_0.setClock(100000); //altere a velocidade entre 100/400 kHz
  confMAX30102();
  mlx.begin(0x5A, &I2C_0); //inicia o sensor MLX90614

}


/*
  // -----[drawHeart]----- //

  QUEM FEZ COMENTA AI RESUMO DOQUE FAZ 
*/
void drawHeart(float scale) {
  int centerX = 8;
  int centerY = 8;

  for (int y = 0; y < 16; y++) {
    for (int x = 0; x < 16; x++) {
      if (pgm_read_byte(&epd_bitmap_coracao[y * 2 + (x / 8)]) & (1 << (7 - (x % 8)))) {
        int dx = x - centerX;
        int dy = y - centerY;
        int sx = centerX + dx * scale;
        int sy = centerY + dy * scale;
        if (sx >= 0 && sx < 128 && sy >= 0 && sy < 64) {
          display.drawPixel(sx, sy, WHITE);
        }
      }
    }
  }
}

/*
  // -----[drawHeart]----- //
  Retorna a Hora e Minutos (HH:MM)
*/
String getHoraAtual() {
  time_t now = time(nullptr);
  struct tm* timeinfo = localtime(&now);
  char buffer[6];
  strftime(buffer, sizeof(buffer), "%H:%M", timeinfo);
  return String(buffer);
}


/*
    FUN√á√ïES DE LEITURA
*/

/*
  // -----[readMAX]----- //
  Faz a Leitura e C√°lculo do SpO2 e BPM
*/
void readMAX() {
 uint32_t ir, red;
 double fred, fir;
 double SpO2 = 0; // SpO2 bruto

#ifdef USEFIFO
 particleSensor.check(); // Verifica o sensor, l√™ at√© 3 amostras

 while (particleSensor.available()) {
  red = particleSensor.getFIFORed();
  ir = particleSensor.getFIFOIR();

 //C√°lculo de BPM
  if (checkForBeat(ir)) {
   long delta = millis() - lastBeat;
   lastBeat = millis();
   beatsPerMinute = 60 / (delta / 1000.0);

   if (beatsPerMinute < 255 && beatsPerMinute > 20) {
    rates[rateSpot++] = (byte)beatsPerMinute;
    rateSpot %= RATE_SIZE;

    beatAvg = 0;
    for (byte x = 0; x < RATE_SIZE; x++) beatAvg += rates[x];
    beatAvg /= RATE_SIZE;
    abpm = beatAvg;
   }
  }

 //C√°lculo de SpO2
  i++;
  fred = (double)red;
  fir = (double)ir;

  avered = avered * frate + red * (1.0 - frate);
  aveir = aveir * frate + ir * (1.0 - frate);
  sumredrms += (fred - avered) * (fred - avered);
  sumirrms += (fir - aveir) * (fir - aveir);

  if ((i % SAMPLING) == 0 && millis() > TIMETOBOOT) {
   if (ir < FINGER_ON) {
    ESpO2 = MINIMUM_SPO2;
   }
  }

  if ((i % Num) == 0) {
   double R = (sqrt(sumredrms) / avered) / (sqrt(sumirrms) / aveir);
   SpO2 = -23.3 * (R - 0.4) + 100;
   ESpO2 = FSpO2 * ESpO2 + (1.0 - FSpO2) * SpO2;

   sumredrms = 0.0;
   sumirrms = 0.0;
   i = 0;
   break;
  }

  particleSensor.nextSample();
 }
#endif

 spo2 = ESpO2;
}

/*
  // ------[readMLX]----- //
  Faz a Leitura da Temperatura
*/
void readMLX() {
 temp = mlx.readObjectTempC(); //leitura da temperatura corporal
}

/*
  // ------[displayOled]----- //
  Cria o C√©rebro Visual do Projeto
*/
void displayOled(bool beat) {
  display.clearDisplay();

  // Hora
  String hora = getHoraAtual();
  display.setCursor(90, 4);
  display.print(hora);

  // Batimento
  float scale = beat ? 0.8 : 1.0;
  drawHeart(scale);

  // BPM
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(20, 4);
  display.print(abpm);
  display.print("BPM");

  // Oxig√™nio
  display.drawBitmap(0, 20, epd_bitmap_gota_de_sangue, 16, 16, WHITE);
  display.setCursor(20, 24);
  display.print(spo2);
  display.print("%");
  // Temperatura
  display.drawBitmap(0, 40, epd_bitmap_termometro, 16, 16, WHITE);
  display.setCursor(20, 44);
  display.print(temp);
  display.print("¬∞C");

  display.display();
}


void atualizarTopicos(){
  topic_pub_request_user = mac_address + "/request_user";
  topic_sub_response_user = mac_address + "/response_user";
  topic_sub_msg = mac_address + "/msg";
}


/*
  // ------[displayMensagem]----- //
  Cria Display para o Evento de Mensagem
*/
void displayMensagem(String msg) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("MENSAGEM:");
  display.setCursor(0, 16);
  display.println(msg);
  display.display();
}


void playWhatsAppSound() {
  for (int i = 0; i < 5; i++) {
    if (melody[i] == 0) {
      noTone(buzzerPin);
      delay(durations[i]);
    } else {
      tone(buzzerPin, melody[i], durations[i]);
      delay(durations[i] + 50);
    }
  }
  noTone(buzzerPin);
}


/*
  VOID SETUP
  // ------[setup]----- //
  Inicia o Wifi
  Configura a Hora Interna do Esp
  Atualisa para o Usu√°rio Salvo
  Captura o Mac Address do Esp
  Inicia as Fun√ß√µes de Inicializa√ß√£o dos Sensores, I2C e Display
  Inicia a Anima√ß√£o de Inicializa√ß√£o
*/
void setup() {
  
    setup_wifi();
    mqttClient.setServer(ip_broker, broker_port);
    mqttClient.setCallback(mqttCallback);

    configTime(-3 * 3600, 0, "pool.ntp.org");

    // Abrir namespace "config" no modo leitura/escrita
    prefs.begin("config", false);
    // Ver se j√° existe valor salvo
    user = prefs.getString("user", "");
    mac_address = WiFi.macAddress();
    client_id = "ESP_"+ mac_address; 
    atualizarTopicos();
    initI2C(); //inicia o barramento I2C
    initDisplay(); //inicia o Display 
    initSensors(); //inicia os sensores
    // Mostra imagem de inicializa√ß√£o
    display.drawBitmap(0, 0, epd_bitmap_7zipLogo__5_, 128, 64, WHITE);
    display.display();
    delay(4000); // Tempo que a logo fica na tela (4 segundos)
    display.clearDisplay();
    display.drawBitmap(0, 0, epd_bitmap_7zipLogo__6_, 128, 64, WHITE);
    display.display();
    delay(4000); // Tempo que a logo fica na tela (4 segundos)
    display.clearDisplay();
    display.setTextSize(1);      // Tamanho padr√£o
    display.setTextColor(WHITE);
    display.setCursor(0,0);
    display.print(mac_address.c_str() );
    display.display();
    delay(4000); // Tempo que a logo fica na tela (4 segundos)
    display.clearDisplay();
    display.display();
    
    pinMode(buzzerPin, OUTPUT);
}
/*
    VOID LOOP
*/



/*
  // ------[loop]----- //
  Verifica a Conex√£o com broker
  Mantem a Conex√£o Viva e Processa Mensagens
  Verifica a Exist√™ncia do Usu√°rio

  VERIVICAR
  Faz a  leitura dos sinais vitais e envia os dados
  FAZER UM FUN√á√ÉO DE RECONECT DO WIFI SE ELE N√ÉO OCNSEGUIR SE CONECTAR NO BROKER IF PRA VE SE TAR CONECTADO NO WIFI SE N√ÉO TENTA CONECTAR

*/
void loop() {
  if (!mqttClient.connected()) {
      if(WiFi.status() != WL_CONNECTED){
        setup_wifi();
      }
      reconnect_mqtt();  // sua fun√ß√£o de reconex√£o
    }
    mqttClient.loop();

    readMLX();
    readMAX();
    

    // Verifica se o user est√° vazio
    if (user == "") {
        static bool primeiraMensagemEnviada = false;
        //pede um novo usu√°rio
        if (!primeiraMensagemEnviada) {
            enviarPrimeiraMensagem();
            primeiraMensagemEnviada = true;
        }
    } else {
        unsigned long tempoAtual = millis();

        // Se passaram 5 segundos?
        if (tempoAtual - tempoAnterior >= intervalo) {
            tempoAnterior = tempoAtual;
            // Aqui voc√™ coloca o que deseja fazer a cada 5 segundos
            for (int i = 0; i < 3; i++) {
            String valor;
            
            if (strcmp(tipos[i], "temperatura") == 0) {
                valor = String(temp, 2); // duas casas decimais

            } else if (strcmp(tipos[i], "oxigenacao") == 0) {
                valor = String(spo2, 2);
                
            } else if (strcmp(tipos[i], "bpm") == 0) {
                valor = String(abpm);

            }

            StaticJsonDocument<200> doc;
            doc["use_id"] = user;
            doc["dados_tipo"] = tipos[i];
            doc["dados_valor"] = valor;
            doc["dados_generate"] = time(NULL);

            String e;
            serializeJson(doc, e);

            String topico = mac_address+ "/" + tipos[i];
            // üöÄ Verifica se a mensagem foi publicada com sucesso
            mqttClient.publish(topico.c_str(), e.c_str());
        }
      }
    }
    
  if (mostrandoMensagem && millis() - tempoMensagem >= 10000) {
    // DESLIGA O BUZER AQUI
    noTone(buzzerPin);
    mostrandoMensagem = false;
    display.clearDisplay();
  }

  if (!mostrandoMensagem && millis() - ultimoBatimento >= 500) {
    batendo = !batendo;
    displayOled(batendo);
    ultimoBatimento = millis();
  }
}
